<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
    // 2. ç«‹å³åˆå§‹åŒ– Socket (è«‹æ›´æ›ç‚ºæ‚¨çš„ Render ç¶²å€)
    const socket = io("https://were-wolf.onrender.com");

    // 3. å®šç¾©æ‰€æœ‰å¿…è¦çš„å…¨åŸŸè®Šæ•¸ (é é˜²æ¸²æŸ“éŒ¯èª¤)
    let myName = "";
    let amIHost = false;
    let myRole = ""; 
    let isAlive = true;
    let currentStatus = "waiting";
    let lastPlayersData = [];
    let wolfStatusData = []; // æ ¼å¼: [{id, targetId, isConfirmed}]
    let witchPotions = { hasSave: true, hasPoison: true }; // åˆå§‹åŒ–è—¥æ°´ç‹€æ…‹

    // 4. å®šç¾©åŠ å…¥æˆ¿é–“åŠŸèƒ½
    function join() {
        const r = document.getElementById("roomInput").value;
        myName = document.getElementById("username").value;
        if(r && myName) {
            socket.emit('joinRoom', { roomId: r, username: myName });
        }
    }

    // 5. ç›£è½èº«åˆ†åˆ†é… (ç”±ä¼ºæœå™¨ä¸»å‹•ç™¼é€)
    socket.on('assignRole', (role) => {
        myRole = role;
        const roleDisplay = document.getElementById("myRole");
        roleDisplay.innerText = "èº«åˆ†ï¼š" + role;
        roleDisplay.style.color = (role === 'ç‹¼äºº' ? 'var(--primary-red)' : 'var(--primary-green)');
        renderList(); 
    });

    // 6. ç›£è½ç‹¼äººå³æ™‚è¡Œç‚ºåŒæ­¥
    socket.on('updateWolfUI', (data) => {
        wolfStatusData = data;
        renderList(); 
    });

    // 7. ç›£è½å…¨åŸŸç©å®¶ç‹€æ…‹æ›´æ–°
    socket.on('updatePlayers', ({ players, status, nightAction }) => {
        lastPlayersData = players;
        currentStatus = status;
        
        // åŒæ­¥ä¼ºæœå™¨ç«¯çš„è—¥æ°´å‰©é¤˜ç‹€æ³
        if (nightAction) {
            witchPotions.hasSave = nightAction.witchHasSave;
            witchPotions.hasPoison = nightAction.witchHasPoison;
        }

        // ä»‹é¢é¡¯ç¤ºé‚è¼¯
        document.getElementById("setup").classList.add("hidden");
        document.getElementById("game").classList.remove("hidden");
        
        const me = players.find(p => p.id === socket.id);
        if(me) { 
            isAlive = me.isAlive; 
            amIHost = me.isHost; 
        }

        // é»‘å¤œèˆ‡ç™½å¤©æ¨¡å¼åˆ‡æ›
        if(status.startsWith('night')) {
            document.body.classList.add("night-mode");
            document.getElementById("chatInput").disabled = true;
        } else {
            document.body.classList.remove("night-mode");
            document.getElementById("chatInput").disabled = !isAlive;
            wolfStatusData = []; // ç™½å¤©é‡ç½®ç‹¼äººç·©å­˜
            const sBtn = document.getElementById("skipBtn");
            if(sBtn) { sBtn.disabled = false; sBtn.innerText = "â­ï¸ è·³éç™¼è¨€"; }
        }

        document.getElementById("wolfSection").classList.toggle("hidden", myRole !== 'ç‹¼äºº');
        renderList();
    });

    // 8. æ ¸å¿ƒæ¸²æŸ“å‡½å¼ (è™•ç†æ‰€æœ‰è§’è‰²æŒ‰éˆ•)
    function renderList() {
        const list = document.getElementById("playerList");
        if (!list) return;
        list.innerHTML = "";
        
        lastPlayersData.forEach(p => {
            const div = document.createElement("div");
            div.className = `player-item ${!p.isAlive ? 'dead' : ''}`;
            
            // ç‹¼äººé¸äººè¦–è¦ºåŒ–ï¼šå€åˆ†è‡ªå·±é¸çš„èˆ‡éšŠå‹é¸çš„
            if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
                const myVote = wolfStatusData.find(d => d.id === socket.id);
                const isTeammateTarget = wolfStatusData.some(d => d.id !== socket.id && d.targetId === p.id);
                
                if (p.id === myVote?.targetId) div.classList.add('target-self');
                else if (isTeammateTarget) div.classList.add('target-teammate');
            }

            // ç‹¼äººéšŠå‹ç¢ºèªç‹€æ…‹
            let confirmTag = "";
            if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
                const info = wolfStatusData.find(d => d.id === p.id);
                if (info?.isConfirmed) confirmTag = `<span class="confirm-tag">å·²é–å®š</span>`;
            }

            const nameClass = (myRole === 'ç‹¼äºº' && p.role === 'ç‹¼äºº') ? 'is-wolf' : '';
            let html = `<span>${p.isHost ? 'ğŸ‘‘' : ''} <span class="${nameClass}">${p.name}</span> ${confirmTag}</span><div>`;

            if (isAlive && p.isAlive) {
                // ç‹¼äººå¤œé–“ï¼šé¸æ“‡ç›®æ¨™
                if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
                    html += `<button class="action-btn btn-kill" onclick="socket.emit('wolfKill','${p.id}')">é¸æ“‡</button>`;
                }
                // å¥³å·«å¤œé–“ï¼šæ•‘äººæˆ–æ¯’è—¥
                if (currentStatus === 'night_witch' && myRole === 'å¥³å·«') {
                    html += `<button class="action-btn" style="background:#27ae60" ${!witchPotions.hasSave ? 'disabled' : ''} onclick="socket.emit('witchAction',{type:'save',targetId:'${p.id}'})">æ•‘äºº</button>`;
                    html += `<button class="action-btn" style="background:#c0392b" ${!witchPotions.hasPoison ? 'disabled' : ''} onclick="socket.emit('witchAction',{type:'poison',targetId:'${p.id}'})">æ¯’æ®º</button>`;
                }
                // é è¨€å®¶å¤œé–“ï¼šæŸ¥é©—èº«åˆ†
                if (currentStatus === 'night_seer' && myRole === 'é è¨€å®¶' && p.id !== socket.id) {
                    html += `<button class="action-btn" style="background:#8e44ad" onclick="socket.emit('checkRole','${p.id}')">æŸ¥é©—</button>`;
                }
                // ç™½å¤©ï¼šæŠ•ç¥¨
                if (currentStatus === 'voting') {
                    html += `<button class="action-btn btn-vote" onclick="socket.emit('castVote','${p.id}')">æŠ•ä»–</button>`;
                }
            }
            div.innerHTML = html + `</div>`;
            list.appendChild(div);
        });

        // ç‹¼äººç¢ºèªæ“Šæ®ºçš„å¤§æŒ‰éˆ•
        if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº' && isAlive) {
            const myInfo = wolfStatusData.find(d => d.id === socket.id);
            const cBtn = document.createElement("button");
            cBtn.className = "confirm-btn-big";
            cBtn.innerText = myInfo?.isConfirmed ? "âœ… ç­‰å¾…éšŠå‹ç¢ºèª..." : "ğŸ”’ ç¢ºèªæ“Šæ®ºç›®æ¨™";
            cBtn.disabled = !myInfo?.targetId || myInfo?.isConfirmed;
            cBtn.onclick = () => socket.emit('wolfConfirm');
            list.appendChild(cBtn);
        }
    }

    // 9. ç™½å¤©è·³éç™¼è¨€åŠŸèƒ½
    function handleSkip() {
        socket.emit('castSkipVote');
        const btn = document.getElementById("skipBtn");
        if(btn) {
            btn.disabled = true;
            btn.innerText = "â³ å·²è«‹æ±‚è·³é";
        }
    }

    // 10. åŸºç¤ç›£è½èˆ‡é€šè¨Š
    socket.on('timerUpdate', (s) => {
        const min = Math.floor(s/60), sec = s%60;
        document.getElementById("timerDisplay").innerText = `${min}:${sec<10?'0':''}${sec}`;
    });
    socket.on('receiveMessage', d => {
        const b = document.getElementById("chatBox");
        b.innerHTML += `<div><b style="color:#3498db">${d.name}:</b> ${d.text}</div>`;
        b.scrollTop = b.scrollHeight;
    });
    socket.on('checkResult', m => alert(m));
    socket.on('errorMessage', m => alert(m));
    socket.on('gameOver', (d) => { alert("éŠæˆ²çµæŸï¼è´å®¶ï¼š" + d.winner); location.reload(); });
</script>
