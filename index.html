<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸº ç‹¼äººæ®ºï¼šåŠŸèƒ½æ¸¬è©¦ç‰ˆ</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --primary-red: #e94560; --primary-green: #27ae60; --accent-gold: #f1c40f; --me-blue: #3498db; }
        body { font-family: sans-serif; background: #1a1a2e; color: #e0e0e0; text-align: center; margin: 0; transition: background 0.5s; overflow-x: hidden; }
        body.night-mode { background: #0b0b1a; }
        body.day-mode { background: #2c3e50; }
        section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin: 10px auto; max-width: 400px; border: 1px solid rgba(255,255,255,0.1); }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.03); border-radius: 8px; border: 2px solid transparent; }
        .player-item.dead { opacity: 0.4; filter: grayscale(0.8); background: rgba(0,0,0,0.4); text-decoration: line-through; }
        .player-item.is-me { border-color: var(--me-blue); background: rgba(52, 152, 219, 0.15); }
        .is-wolf { color: var(--primary-red); font-weight: bold; text-shadow: 0 0 5px black; }
        .vote-indicator { display: flex; gap: 4px; margin-left: 8px; }
        .wolf-dot { width: 10px; height: 10px; background: var(--primary-red); border-radius: 50%; border: 1px solid white; transition: 0.3s; }
        .action-btn { padding: 6px 12px; font-size: 13px; border: none; border-radius: 4px; cursor: pointer; color: white; margin: 0 2px; font-weight: bold; }
        .chat-area { height: 120px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 8px; text-align: left; margin-bottom: 5px; border: 1px solid #444; font-size: 14px; border-radius: 4px; }
        .hidden { display: none !important; }
        input { background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 4px; width: 85%; margin-bottom: 10px; }
        #timerDisplay { font-size: 40px; font-weight: bold; margin: 10px 0; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #timerDisplay.day-timer { color: var(--accent-gold); }
        #timerDisplay.night-timer { color: var(--primary-red); }
        .wolf-chat-container { border: 2px solid var(--primary-red); background: rgba(233, 69, 96, 0.05); }
    </style>
</head>
<body>
    <div id="setup">
        <section>
            <h2 style="color: var(--accent-gold);">ğŸº ç‹¼äººæ®ºï¼šé€£ç·šæ¸¬è©¦ç‰ˆ</h2>
            <input type="text" id="roomInput" placeholder="æˆ¿é–“è™Ÿç¢¼">
            <input type="text" id="username" placeholder="æš±ç¨±">
            <button onclick="join()" style="width:90%; background:var(--primary-green); color:white; padding:15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">é€²å…¥éŠæˆ²</button>
        </section>
    </div>

    <main id="game" class="hidden">
        <section>
            <div style="margin-bottom: 5px;">ç•¶å‰éšæ®µï¼š<span id="gamePhase" style="color:var(--accent-gold); font-weight:bold;">ç­‰å¾…ä¸­</span></div>
            <div id="myRole" style="font-size: 1.4em; margin: 10px 0; font-weight: bold;">â³ ç­‰å¾…ç™¼ç‰Œ...</div>
            <div id="timerDisplay" class="day-timer">--:--</div>
            <div id="nightNotice" style="color: var(--accent-gold); font-size: 15px; min-height: 24px; font-weight: bold;"></div>
            
            <div id="hostControls" class="hidden">
                <button id="startBtn" onclick="socket.emit('startGame')" style="background:var(--primary-green); color:white; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">æ­£å¼é–‹å§‹</button>
                <div style="margin-top:10px;">
                    <button onclick="socket.emit('addTestBots')" style="background:#555; color:white; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; font-size:12px;">ğŸ¤– è£œæ»¿æ©Ÿå™¨äººæ¸¬è©¦</button>
                </div>
            </div>

            <button id="skipBtn" class="hidden" onclick="socket.emit('castSkipVote')" style="background:var(--me-blue); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; width: 100%; margin-top: 10px;">â­ï¸ æˆ‘ç™¼è¨€å®Œäº† (è·³é)</button>
        </section>

        <section id="wolfSection" class="hidden wolf-chat-container">
            <div style="color: var(--primary-red); font-weight: bold; margin-bottom:5px;">ğŸ¾ ç‹¼äººç§å¯†å°è©±</div>
            <div id="wolfChatBox" class="chat-area"></div>
            <input type="text" id="wolfInput" placeholder="èˆ‡éšŠå‹ç­–åŠƒä¸­..." onkeypress="if(event.key==='Enter') sendWolfChat()" style="width:85%; border-color:var(--primary-red)">
        </section>

        <section>
            <h3 style="margin-top:0;">ğŸ‘¥ ç©å®¶åå–®</h3>
            <div id="playerList"></div>
        </section>

        <section>
            <div id="chatBox" class="chat-area"></div>
            <input type="text" id="chatInput" placeholder="å…¬é–‹è¨è«–..." onkeypress="if(event.key==='Enter') send()" style="width:85%;">
        </section>
    </main>

    <script>
        const socket = io("https://were-wolf.onrender.com");
        let myName = "", myRole = null, amIHost = false, isAlive = true;
        let wolfStatusData = [], witchPotions = { hasSave: true, hasPoison: true };
        let lastPlayers = [];

        function join() {
            myName = document.getElementById("username").value.trim();
            const r = document.getElementById("roomInput").value.trim();
            if(r && myName) socket.emit('joinRoom', { roomId: r, username: myName });
            else alert("è«‹è¼¸å…¥æˆ¿è™Ÿèˆ‡æš±ç¨±");
        }

        socket.on('updatePlayers', ({ players, status, witchPotions: wp }) => {
            document.getElementById("setup").classList.add("hidden");
            document.getElementById("game").classList.remove("hidden");
            lastPlayers = players;
            
            const me = players.find(p => p.id === socket.id);
            if(me) { 
                isAlive = me.isAlive; 
                amIHost = me.isHost; 
            }
            if(wp) witchPotions = wp;

            const phaseEl = document.getElementById("gamePhase");
            phaseEl.innerText = translateStatus(status);
            
            const isNight = status.startsWith('night');
            document.body.className = isNight ? "night-mode" : (status === 'day' ? "day-mode" : "");
            document.getElementById("timerDisplay").className = isNight ? "night-timer" : "day-timer";
            
            // æˆ¿ä¸»æ§åˆ¶æŒ‰éˆ•åƒ…åœ¨ç­‰å¾…éšæ®µé¡¯ç¤º
            document.getElementById("hostControls").classList.toggle("hidden", !amIHost || status !== 'waiting');
            
            if (status === 'waiting') {
                // é‡ç½®æ‰€æœ‰éŠæˆ²ä¸­çš„è¦–è¦ºæç¤º
                document.getElementById("myRole").innerText = "â³ ç­‰å¾…ç™¼ç‰Œ...";
                document.getElementById("myRole").style.color = "white";
                document.getElementById("nightNotice").innerText = "";
                document.getElementById("timerDisplay").innerText = "--:--";
                myRole = null; // æ¸…é™¤æœ¬åœ°èº«åˆ†ç·©å­˜
            }

            if (!isNight && status !== 'waiting') document.getElementById("nightNotice").innerText = "";

            renderList(players, status);
        });

        function translateStatus(s) {
            const map = { 'waiting': 'ç­‰å¾…é–‹å±€', 'night_wolf': 'ç‹¼äººè¡Œå‹•', 'night_witch': 'å¥³å·«è¡Œå‹•', 'night_seer': 'é è¨€å®¶é©—äºº', 'day': 'è‡ªç”±ç™¼è¨€', 'voting': 'æŠ•ç¥¨æ”¾é€' };
            return map[s] || s;
        }

        socket.on('updateWolfUI', (data) => {
            wolfStatusData = data;
            renderList(lastPlayers, document.getElementById("gamePhase").innerText);
        });

        function renderList(players, status) {
            if(!players || players.length === 0) return;
            const list = document.getElementById("playerList");
            list.innerHTML = "";
            
            players.forEach(p => {
                const isMe = p.id === socket.id;
                const div = document.createElement("div");
                div.className = `player-item ${!p.isAlive ? 'dead' : ''} ${isMe ? 'is-me' : ''}`;
                
                // ç‹¼äººå°ç´…é»
                let dots = '<div class="vote-indicator">';
                if (myRole === 'ç‹¼äºº' && status.startsWith('night')) {
                    wolfStatusData.filter(v => v.targetId === p.id).forEach(v => {
                        dots += `<div class="wolf-dot" style="${v.isConfirmed ? 'box-shadow: 0 0 8px #f1c40f; border-color:#f1c40f;' : ''}"></div>`;
                    });
                }
                dots += '</div>';

                // è¡Œå‹•æŒ‰éˆ•é‚è¼¯
                let btns = `<div>`;
                if (isAlive && p.isAlive && status !== 'waiting') {
                    if (status === 'night_wolf' && myRole === 'ç‹¼äºº') 
                        btns += `<button class="action-btn" style="background:var(--primary-red)" onclick="socket.emit('wolfKill','${p.id}')">é¸</button>`;
                    
                    if (status === 'night_witch' && myRole === 'å¥³å·«') {
                        if(witchPotions.hasSave) btns += `<button class="action-btn" style="background:var(--primary-green)" onclick="socket.emit('witchAction',{type:'save',targetId:'${p.id}'})">æ•‘</button>`;
                        if(witchPotions.hasPoison) btns += `<button class="action-btn" style="background:#8e44ad" onclick="socket.emit('witchAction',{type:'poison',targetId:'${p.id}'})">æ¯’</button>`;
                    }
                    
                    if (status === 'night_seer' && myRole === 'é è¨€å®¶' && !isMe) 
                        btns += `<button class="action-btn" style="background:var(--me-blue)" onclick="socket.emit('checkRole','${p.id}')">é©—</button>`;
                    
                    if (status === 'voting' && !isMe) 
                        btns += `<button class="action-btn" style="background:var(--accent-gold)" onclick="socket.emit('castVote','${p.id}')">æŠ•</button>`;
                }
                btns += `</div>`;

                const roleClass = (myRole === 'ç‹¼äºº' && p.role === 'ç‹¼äºº') ? 'is-wolf' : '';
                const nameTag = `${p.isHost ? 'ğŸ‘‘ ' : ''}${p.isBot ? 'ğŸ¤– ' : ''}${p.name}${isMe ? ' (æˆ‘)' : ''}`;
                
                div.innerHTML = `<span><span class="${roleClass}">${nameTag}</span>${dots}</span>${btns}`;
                list.appendChild(div);
            });

            if (status === 'night_wolf' && myRole === 'ç‹¼äºº' && isAlive) {
                const myV = wolfStatusData.find(v => v.id === socket.id);
                const b = document.createElement("button");
                b.innerText = myV?.isConfirmed ? "âœ… å·²ç¢ºèªæ®ºå®³" : "ğŸ”’ ç¢ºå®šæ­¤ç›®æ¨™";
                b.disabled = !myV?.targetId || myV?.isConfirmed;
                b.onclick = () => socket.emit('wolfConfirm');
                b.style = `width:100%; margin-top:10px; background:${myV?.isConfirmed?'#444':'var(--primary-red)'}; color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;`;
                list.appendChild(b);
            }

            document.getElementById("skipBtn").classList.toggle("hidden", status !== 'day' || !isAlive);
            document.getElementById("wolfSection").classList.toggle("hidden", myRole !== 'ç‹¼äºº' || status === 'waiting');
        }

        socket.on('assignRole', r => { 
            myRole = r; 
            const el = document.getElementById("myRole");
            el.innerText = "ä½ çš„èº«åˆ†ï¼š" + r; 
            el.style.color = (r === 'ç‹¼äºº' ? 'var(--primary-red)' : 'var(--primary-green)');
        });

        socket.on('timerUpdate', s => {
            const timerEl = document.getElementById("timerDisplay");
            if (s >= 60) {
                const mins = Math.floor(s / 60);
                const secs = (s % 60).toString().padStart(2, '0');
                timerEl.innerText = `${mins}:${secs}`;
            } else {
                timerEl.innerText = s;
            }
        });

        socket.on('receiveMessage', d => { 
            const b = document.getElementById("chatBox"); 
            b.innerHTML += `<div><span style="color:var(--accent-gold)">${d.name}:</span> ${d.text}</div>`; 
            b.scrollTop = b.scrollHeight; 
        });

        socket.on('receiveWolfMessage', d => { 
            const b = document.getElementById("wolfChatBox"); 
            b.innerHTML += `<div><span style="color:var(--primary-red)">${d.name}:</span> ${d.text}</div>`; 
            b.scrollTop = b.scrollHeight; 
        });

        socket.on('witchTarget', d => { 
            if(myRole === 'å¥³å·«') document.getElementById("nightNotice").innerText = `ğŸ§ª ç³»çµ±é€šçŸ¥ï¼š${d.name} æ˜¨æ™šå€’ä¸‹äº†`; 
        });

        socket.on('checkResult', m => alert(m));
        socket.on('errorMessage', m => alert(m));

        socket.on('gameOver', d => { 
            setTimeout(() => {
                alert("éŠæˆ²çµæŸï¼\nè´å®¶æ˜¯ï¼š" + d.winner + "\n\næˆ¿è™Ÿä»æœ‰æ•ˆï¼ŒåŸç­äººé¦¬å¯ç¹¼çºŒé€²è¡Œä¸‹ä¸€å±€ã€‚"); 
            }, 500);
            // ç§»é™¤ location.reload();
            myRole = null;
            wolfStatusData = [];
        });

        function send() { 
            const i = document.getElementById("chatInput"); 
            if(i.value.trim()) socket.emit('sendMessage', {name: myName, text: i.value}); 
            i.value=""; 
        }
        function sendWolfChat() { 
            const i = document.getElementById("wolfInput"); 
            if(i.value.trim()) socket.emit('sendWolfMessage', {name: myName, text: i.value}); 
            i.value=""; 
        }
    </script>
</body>
</html>
