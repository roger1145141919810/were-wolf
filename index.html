<script>
    const socket = io("https://were-wolf.onrender.com");
    let myName = "", myRole = null, amIHost = false, isAlive = true;
    let wolfStatusData = [], witchPotions = { hasSave: true, hasPoison: true };
    let lastPlayers = [];

    function join() {
        myName = document.getElementById("username").value.trim();
        const r = document.getElementById("roomInput").value.trim();
        if(r && myName) socket.emit('joinRoom', { roomId: r, username: myName });
        else alert("è«‹è¼¸å…¥æˆ¿è™Ÿèˆ‡æš±ç¨±");
    }

    socket.on('updatePlayers', ({ players, status, witchPotions: wp }) => {
        document.getElementById("setup").classList.add("hidden");
        document.getElementById("game").classList.remove("hidden");
        lastPlayers = players;
        
        const me = players.find(p => p.id === socket.id);
        if(me) { 
            isAlive = me.isAlive; 
            amIHost = me.isHost; 
        }
        if(wp) witchPotions = wp;

        const phaseEl = document.getElementById("gamePhase");
        phaseEl.innerText = translateStatus(status);
        
        const isNight = status.startsWith('night');
        document.body.className = isNight ? "night-mode" : (status === 'day' ? "day-mode" : "");
        document.getElementById("timerDisplay").className = isNight ? "night-timer" : "day-timer";
        
        document.getElementById("hostControls").classList.toggle("hidden", !amIHost || status !== 'waiting');
        
        // --- BUG ä¿®æ­£é» 1: åœ¨ç­‰å¾…éšæ®µå¼·åˆ¶é‡ç½®å‰ç«¯è®Šæ•¸èˆ‡ UI ---
        if (status === 'waiting') {
            myRole = null; 
            wolfStatusData = [];
            document.getElementById("myRole").innerText = "â³ ç­‰å¾…ç™¼ç‰Œ...";
            document.getElementById("myRole").style.color = "white";
            document.getElementById("nightNotice").innerText = "";
            document.getElementById("timerDisplay").innerText = "--:--";
            document.getElementById("wolfChatBox").innerHTML = ""; // é¡å¤–é‡ç½®ç‹¼äººèŠå¤©å®¤
        }

        if (!isNight && status !== 'waiting') document.getElementById("nightNotice").innerText = "";

        renderList(players, status);
    });

    function translateStatus(s) {
        const map = { 'waiting': 'ç­‰å¾…é–‹å±€', 'night_wolf': 'ç‹¼äººè¡Œå‹•', 'night_witch': 'å¥³å·«è¡Œå‹•', 'night_seer': 'é è¨€å®¶é©—äºº', 'day': 'è‡ªç”±ç™¼è¨€', 'voting': 'æŠ•ç¥¨æ”¾é€' };
        return map[s] || s;
    }

    socket.on('updateWolfUI', (data) => {
        wolfStatusData = data;
        renderList(lastPlayers, document.getElementById("gamePhase").innerText);
    });

    function renderList(players, status) {
        if(!players || players.length === 0) return;
        const list = document.getElementById("playerList");
        list.innerHTML = "";
        
        players.forEach(p => {
            const isMe = p.id === socket.id;
            const div = document.createElement("div");
            div.className = `player-item ${!p.isAlive ? 'dead' : ''} ${isMe ? 'is-me' : ''}`;
            
            let dots = '<div class="vote-indicator">';
            // --- BUG ä¿®æ­£é» 2: åš´æ ¼æª¢æŸ¥è‡ªå·±æ˜¯ç‹¼äººæ‰æ¸²æŸ“ç´…é» ---
            if (myRole === 'ç‹¼äºº' && status.startsWith('night')) {
                wolfStatusData.filter(v => v.targetId === p.id).forEach(v => {
                    dots += `<div class="wolf-dot" style="${v.isConfirmed ? 'box-shadow: 0 0 8px #f1c40f; border-color:#f1c40f;' : ''}"></div>`;
                });
            }
            dots += '</div>';

            let btns = `<div>`;
            if (isAlive && p.isAlive && status !== 'waiting') {
                if (status === 'night_wolf' && myRole === 'ç‹¼äºº') 
                    btns += `<button class="action-btn" style="background:var(--primary-red)" onclick="socket.emit('wolfKill','${p.id}')">é¸</button>`;
                
                if (status === 'night_witch' && myRole === 'å¥³å·«') {
                    if(witchPotions.hasSave) btns += `<button class="action-btn" style="background:var(--primary-green)" onclick="socket.emit('witchAction',{type:'save',targetId:'${p.id}'})">æ•‘</button>`;
                    if(witchPotions.hasPoison) btns += `<button class="action-btn" style="background:#8e44ad" onclick="socket.emit('witchAction',{type:'poison',targetId:'${p.id}'})">æ¯’</button>`;
                }
                
                if (status === 'night_seer' && myRole === 'é è¨€å®¶' && !isMe) 
                    btns += `<button class="action-btn" style="background:var(--me-blue)" onclick="socket.emit('checkRole','${p.id}')">é©—</button>`;
                
                if (status === 'voting' && !isMe) 
                    btns += `<button class="action-btn" style="background:var(--accent-gold)" onclick="socket.emit('castVote','${p.id}')">æŠ•</button>`;
            }
            btns += `</div>`;

            // --- BUG ä¿®æ­£é» 3: åš´æ ¼æª¢æŸ¥è‡ªå·±æ˜¯ç‹¼äººæ‰æ¸²æŸ“éšŠå‹å§“åé¡è‰² ---
            const isWolfTeammate = (myRole === 'ç‹¼äºº' && p.role === 'ç‹¼äºº');
            const roleClass = isWolfTeammate ? 'is-wolf' : '';
            const nameTag = `${p.isHost ? 'ğŸ‘‘ ' : ''}${p.isBot ? 'ğŸ¤– ' : ''}${p.name}${isMe ? ' (æˆ‘)' : ''}`;
            
            div.innerHTML = `<span><span class="${roleClass}">${nameTag}</span>${dots}</span>${btns}`;
            list.appendChild(div);
        });

        if (status === 'night_wolf' && myRole === 'ç‹¼äºº' && isAlive) {
            const myV = wolfStatusData.find(v => v.id === socket.id);
            const b = document.createElement("button");
            b.innerText = myV?.isConfirmed ? "âœ… å·²ç¢ºèªæ®ºå®³" : "ğŸ”’ ç¢ºå®šæ­¤ç›®æ¨™";
            b.disabled = !myV?.targetId || myV?.isConfirmed;
            b.onclick = () => socket.emit('wolfConfirm');
            b.style = `width:100%; margin-top:10px; background:${myV?.isConfirmed?'#444':'var(--primary-red)'}; color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;`;
            list.appendChild(b);
        }

        document.getElementById("skipBtn").classList.toggle("hidden", status !== 'day' || !isAlive);
        document.getElementById("wolfSection").classList.toggle("hidden", myRole !== 'ç‹¼äºº' || status === 'waiting');
    }

    socket.on('assignRole', r => { 
        myRole = r; 
        const el = document.getElementById("myRole");
        el.innerText = "ä½ çš„èº«åˆ†ï¼š" + r; 
        el.style.color = (r === 'ç‹¼äºº' ? 'var(--primary-red)' : 'var(--primary-green)');
        // ç¢ºä¿ç™¼ç‰Œæ™‚æ¸…ç©ºèˆŠé€šå‘Š
        document.getElementById("nightNotice").innerText = "";
    });

    socket.on('timerUpdate', s => {
        const timerEl = document.getElementById("timerDisplay");
        if (s >= 60) {
            const mins = Math.floor(s / 60);
            const secs = (s % 60).toString().padStart(2, '0');
            timerEl.innerText = `${mins}:${secs}`;
        } else {
            timerEl.innerText = s;
        }
    });

    socket.on('receiveMessage', d => { 
        const b = document.getElementById("chatBox"); 
        b.innerHTML += `<div><span style="color:var(--accent-gold)">${d.name}:</span> ${d.text}</div>`; 
        b.scrollTop = b.scrollHeight; 
    });

    socket.on('receiveWolfMessage', d => { 
        const b = document.getElementById("wolfChatBox"); 
        b.innerHTML += `<div><span style="color:var(--primary-red)">${d.name}:</span> ${d.text}</div>`; 
        b.scrollTop = b.scrollHeight; 
    });

    socket.on('witchTarget', d => { 
        if(myRole === 'å¥³å·«') document.getElementById("nightNotice").innerText = `ğŸ§ª ç³»çµ±é€šçŸ¥ï¼š${d.name} æ˜¨æ™šå€’ä¸‹äº†`; 
    });

    socket.on('checkResult', m => alert(m));
    socket.on('errorMessage', m => alert(m));

    socket.on('gameOver', d => { 
        setTimeout(() => {
            alert("éŠæˆ²çµæŸï¼\nè´å®¶æ˜¯ï¼š" + d.winner + "\n\næˆ¿è™Ÿä»æœ‰æ•ˆï¼ŒåŸç­äººé¦¬å¯ç¹¼çºŒé€²è¡Œä¸‹ä¸€å±€ã€‚"); 
        }, 500);
        // æ­¤è™•ä¸éœ€é¡å¤–å‹•ä½œï¼Œç”± updatePlayers çš„ 'waiting' ç‹€æ…‹çµ±ä¸€é‡ç½®
    });

    function send() { 
        const i = document.getElementById("chatInput"); 
        if(i.value.trim()) socket.emit('sendMessage', {name: myName, text: i.value}); 
        i.value=""; 
    }
    function sendWolfChat() { 
        const i = document.getElementById("wolfInput"); 
        if(i.value.trim()) socket.emit('sendWolfMessage', {name: myName, text: i.value}); 
        i.value=""; 
    }
</script>
